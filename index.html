<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGNITE | AI MIDI Sequencer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: #050505;
            background-image: radial-gradient(circle at 50% 0%, #1f1005 0%, #050505 50%);
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        
        .glass-panel {
            background: rgba(18, 18, 20, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7), 0 0 40px rgba(255, 100, 0, 0.05);
        }

        .locked { filter: blur(8px) grayscale(50%); pointer-events: none; user-select: none; transition: filter 0.8s ease; }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 8px;
            border-radius: 2px;
            background: #ff5e00;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 0 10px rgba(255, 94, 0, 0.6);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #2a2a2a;
            border-radius: 2px;
        }
        input[type=range]:focus { outline: none; }

        .pro-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #2a2a2a;
            color: #fff;
            transition: all 0.3s ease;
        }
        .pro-input:focus {
            border-color: #ff5e00;
            box-shadow: 0 0 15px rgba(255, 94, 0, 0.2);
            outline: none;
        }

        .eq-bar {
            width: 4px;
            background: #fff;
            border-radius: 2px;
            animation: eq 1s ease-in-out infinite;
        }
        .eq-bar:nth-child(2) { animation-delay: 0.2s; }
        .eq-bar:nth-child(3) { animation-delay: 0.4s; }
        @keyframes eq {
            0%, 100% { height: 8px; }
            50% { height: 20px; }
        }

        /* Credits Badge Style */
        .credits-badge {
            background: rgba(255, 94, 0, 0.1);
            border: 1px solid rgba(255, 94, 0, 0.3);
            color: #ff5e00;
            padding: 4px 12px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 900;
            letter-spacing: 0.1em;
        }
    </style>
</head>
<body class="text-gray-100 min-h-screen flex flex-col items-center justify-center p-4 relative overflow-x-hidden">

    <div class="fixed top-[-20%] left-[-10%] w-[50%] h-[50%] rounded-full bg-orange-600/5 blur-[120px] pointer-events-none"></div>
    <div class="fixed bottom-[-20%] right-[-10%] w-[50%] h-[50%] rounded-full bg-red-600/5 blur-[120px] pointer-events-none"></div>

    <div id="auth-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md transition-opacity">
        <div class="glass-panel rounded-2xl p-10 w-full max-w-sm text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-500 to-red-500"></div>
            
            <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-red-500 mb-2 tracking-tight">IGNITE ENGINE</h2>
            <p class="text-xs text-gray-400 mb-8 uppercase tracking-widest">License Authentication</p>
            
            <div class="space-y-5 mb-8 text-left">
                <div>
                    <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-1 ml-1">Producer Email</label>
                    <input type="email" id="email-input" placeholder="studio@domain.com" class="w-full pro-input rounded-lg p-3 text-sm">
                </div>
                <div>
                    <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-1 ml-1">Access Key</label>
                    <input type="password" id="password-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full pro-input rounded-lg p-3 text-sm">
                </div>
            </div>

            <button onclick="handleLogin()" class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-400 hover:to-red-400 text-white font-bold py-3.5 rounded-xl mb-3 transition-all shadow-[0_0_20px_rgba(255,94,0,0.3)] hover:shadow-[0_0_30px_rgba(255,94,0,0.5)] flex justify-center items-center gap-2 text-sm uppercase tracking-wider">
                Unlock Engine
            </button>
            <button onclick="handleSignUp()" class="w-full bg-transparent border border-gray-700 hover:border-gray-500 text-gray-400 font-bold py-3 rounded-xl transition-colors text-sm uppercase tracking-wider">
                Register New
            </button>
            <p id="auth-status" class="text-xs mt-5 font-medium h-4 text-center tracking-wide"></p>
        </div>
    </div>

    <div id="app-content" class="locked w-full max-w-lg flex flex-col items-center transition-all duration-700 z-10">
        
        <div class="w-full flex justify-between items-end mb-6 px-2">
            <div>
                <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-red-500 tracking-tighter leading-none">IGNITE</h1>
                <div class="flex items-center gap-2 mt-1">
                    <p class="text-[10px] text-gray-500 font-bold tracking-[0.3em] ml-1">AI MIDI SEQUENCER</p>
                    <span id="credit-badge" class="credits-badge hidden">--/30 USED</span>
                </div>
            </div>
            <button onclick="handleLogout()" class="text-xs text-gray-600 hover:text-red-400 transition-colors uppercase tracking-wider font-bold">Disconnect</button>
        </div>

        <div class="glass-panel rounded-3xl p-8 w-full relative">
            
            <div class="mb-8">
                <div class="flex items-center gap-3 mb-4">
                    <div class="h-[1px] flex-1 bg-gradient-to-r from-transparent to-gray-800"></div>
                    <span class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Global Parameters</span>
                    <div class="h-[1px] flex-1 bg-gradient-to-l from-transparent to-gray-800"></div>
                </div>

                <div class="mb-4">
                    <label class="block text-xs text-gray-400 mb-1.5 ml-1 font-medium">Musical Style</label>
                    <select id="style" class="w-full pro-input rounded-xl p-3.5 text-sm appearance-none">
                        <option>Neo-Soul</option><option>Cinematic</option><option>Techno</option><option>Jazz</option><option>Lofi</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1.5 ml-1 font-medium">Key</label>
                        <select id="key" class="w-full pro-input rounded-xl p-3.5 text-sm appearance-none">
                            <option>C</option><option>C#</option><option>D</option><option>D#</option>
                            <option>E</option><option>F</option><option>F#</option><option>G</option>
                            <option>G#</option><option>A</option><option>A#</option><option>B</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1.5 ml-1 font-medium">Scale / Mode</label>
                        <select id="mode" class="w-full pro-input rounded-xl p-3.5 text-sm appearance-none">
                            <option>Minor (Aeolian)</option><option>Major (Ionian)</option><option>Dorian</option>
                            <option>Phrygian</option><option>Lydian</option><option>Mixolydian</option><option>Harmonic Minor</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1.5 ml-1 font-medium">Tempo (BPM)</label>
                        <input type="number" id="bpm" value="85" class="w-full pro-input rounded-xl p-3.5 text-sm text-center font-bold text-orange-400">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1.5 ml-1 font-medium">Length (Bars)</label>
                        <select id="bars" class="w-full pro-input rounded-xl p-3.5 text-sm appearance-none text-center">
                            <option value="4">4 Bars</option><option value="8" selected>8 Bars</option><option value="16">16 Bars</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <div class="flex items-center gap-3 mb-6">
                    <div class="h-[1px] flex-1 bg-gradient-to-r from-transparent to-gray-800"></div>
                    <span class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Groove & Theory</span>
                    <div class="h-[1px] flex-1 bg-gradient-to-l from-transparent to-gray-800"></div>
                </div>

                <div class="space-y-6 bg-black/20 p-5 rounded-2xl border border-white/5">
                    <div>
                        <div class="flex justify-between text-xs mb-3 font-medium">
                            <span class="text-gray-400">Humanize / Swing</span>
                            <span id="swing-val" class="text-orange-500">45ms</span>
                        </div>
                        <input type="range" id="swing" min="0" max="100" value="45" oninput="document.getElementById('swing-val').innerText = this.value + 'ms'">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-3 font-medium">
                            <span class="text-gray-400">Syncopation Matrix</span>
                            <span id="sync-val" class="text-orange-500">30%</span>
                        </div>
                        <input type="range" id="sync" min="1" max="100" value="30" oninput="document.getElementById('sync-val').innerText = this.value + '%'">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-3 font-medium">
                            <span class="text-gray-400">Harmonic Density</span>
                            <span id="comp-val" class="text-orange-500">Lvl 4</span>
                        </div>
                        <input type="range" id="comp" min="1" max="5" value="4" oninput="document.getElementById('comp-val').innerText = 'Lvl ' + this.value">
                    </div>
                </div>
            </div>

            <div class="mb-8 border-t border-white/5 pt-6">
                <div class="flex items-center justify-between mb-4 px-2">
                    <span class="text-[10px] uppercase text-gray-500 tracking-[0.3em] font-bold">EXPERT DNA SETTINGS</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="expert-toggle" class="sr-only peer" onchange="document.getElementById('advanced-panel').classList.toggle('hidden')">
                        <div class="w-9 h-5 bg-gray-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-orange-500 border border-gray-600"></div>
                    </label>
                </div>
                
                <div id="advanced-panel" class="hidden space-y-6 bg-black/40 p-6 rounded-3xl border border-white/5 transition-all">
                    <div>
                        <div class="flex justify-between text-[10px] text-gray-500 mb-2 uppercase"><span>Note Density (Air)</span><span id="dens-v" class="text-orange-400">70%</span></div>
                        <input type="range" id="density" value="70" oninput="document.getElementById('dens-v').innerText=this.value+'%'">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 mb-2 block uppercase">Octave Range</label>
                        <select id="octave" class="w-full pro-input p-3 rounded-xl text-xs">
                            <option value="low">Deep Bass (C1-C2)</option><option value="mid" selected>Mid Range (C3-C5)</option><option value="high">High Lead (C5-C7)</option><option value="wide">Wide Full Keyboard</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 mb-2 block uppercase">Articulation</label>
                        <select id="artic" class="w-full pro-input p-3 rounded-xl text-xs">
                            <option value="staccato">Sharp & Plucky</option><option value="balanced" selected>Natural Flow</option><option value="legato">Lush & Sustained</option>
                        </select>
                    </div>
                </div>
            </div>

            <button id="generate-btn" onclick="generateMidi()" class="w-full bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-400 hover:to-red-500 text-white font-black py-5 rounded-2xl shadow-[0_10px_30px_rgba(255,50,0,0.3)] hover:shadow-[0_10px_40px_rgba(255,50,0,0.5)] hover:-translate-y-1 transition-all flex items-center justify-center gap-3 text-lg tracking-wider group">
                
                <div id="spinner" class="hidden flex items-end h-5 gap-1">
                    <div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div>
                </div>
                
                <span id="btn-text">INSPIRE ME</span>
                
                <svg id="wand-icon" class="w-5 h-5 opacity-70 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
            </button>
            
            <div class="h-6 mt-4 flex items-center justify-center">
                <p id="status" class="text-[11px] text-gray-500 uppercase tracking-widest font-bold">Engine Ready</p>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCP6Wt4yAkkphPeUvgbgbLHeUfdijZw7M4",
            authDomain: "veero-next.firebaseapp.com",
            projectId: "veero-next",
            storageBucket: "veero-next.firebasestorage.app",
            messagingSenderId: "293344511627",
            appId: "1:293344511627:web:7611f4358284b18422b68e"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const authModal = document.getElementById('auth-modal');
        const appContent = document.getElementById('app-content');
        const authStatus = document.getElementById('auth-status');
        const creditBadge = document.getElementById('credit-badge');

        auth.onAuthStateChanged(async user => {
            if (user) {
                authModal.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => authModal.classList.add('hidden'), 500);
                appContent.classList.remove('locked');
                updateCreditsUI(user.uid);
            } else {
                authModal.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
                appContent.classList.add('locked');
                if(creditBadge) creditBadge.classList.add('hidden');
            }
        });

        async function updateCreditsUI(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    const data = userDoc.data();
                    const currentMonth = new Date().getMonth();
                    let credits = data.credits_used || 0;
                    if (data.last_active_month !== currentMonth) {
                        credits = 0;
                    }
                    // ×˜×™×¤×•×œ ×‘×ª×¦×•×’×” ×¢×‘×•×¨ ×ž×©×ª×ž×©×™ Admin (×ž×¡×¤×¨ ×©×œ×™×œ×™ ×ž×•×¡×ª×¨)
                    if(credits < 0) {
                        creditBadge.innerText = "ADMIN ACCESS";
                    } else {
                        creditBadge.innerText = `${credits}/30 USED`;
                    }
                    creditBadge.classList.remove('hidden');
                }
            } catch (e) {
                console.error("Credit fetch error:", e);
            }
        }

        async function handleSignUp() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            authStatus.innerText = "AUTHORIZING...";
            authStatus.className = "text-xs mt-5 font-bold h-4 text-center text-orange-400 tracking-wider";
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await db.collection('users').doc(userCredential.user.uid).set({
                    email: email,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    generations_count: 0,
                    credits_used: 0,
                    last_active_month: new Date().getMonth()
                });
            } catch (error) {
                authStatus.innerText = error.message.replace('Firebase: ', '');
                authStatus.className = "text-xs mt-5 font-bold h-4 text-center text-red-500";
            }
        }

        async function handleLogin() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            authStatus.innerText = "CONNECTING TO SERVER...";
            authStatus.className = "text-xs mt-5 font-bold h-4 text-center text-orange-400 tracking-wider";
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                authStatus.innerText = "INVALID CREDENTIALS";
                authStatus.className = "text-xs mt-5 font-bold h-4 text-center text-red-500 tracking-wider";
            }
        }

        function handleLogout() {
            auth.signOut();
        }

        async function generateMidi() {
            const btn = document.getElementById('generate-btn');
            const btnText = document.getElementById('btn-text');
            const status = document.getElementById('status');
            const spinner = document.getElementById('spinner');
            const wandIcon = document.getElementById('wand-icon');
            const user = auth.currentUser;

            if (!user) return;

            // 1. ×‘×“×™×§×ª ×§×¨×“×™×˜×™× ×¢× ×”×’× ×” ×—×›×ž×” ×œ×ž×¡×ž×›×™× ×—×¡×¨×™×
            let creditsUsed = 0;
            let currentMonth = new Date().getMonth();

            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    creditsUsed = userData.credits_used || 0;
                    if (userData.last_active_month !== currentMonth) creditsUsed = 0;
                } else {
                    // ×× ×”×ž×©×ª×ž×© ×§×™×™× ×‘-Auth ××‘×œ ××™×Ÿ ×œ×• ×ž×¡×ž×š ×‘-DB, × ×™×¦×•×¨ ××—×“ ×¢×›×©×™×•
                    await db.collection('users').doc(user.uid).set({
                        email: user.email,
                        credits_used: 0,
                        last_active_month: currentMonth,
                        generations_count: 0
                    });
                }

                if (creditsUsed >= 30) {
                    status.innerText = "MONTHLY LIMIT REACHED (30/30).";
                    status.className = "text-[11px] text-red-500 uppercase tracking-widest font-black";
                    return;
                }
            } catch (err) {
                console.error("Firestore Check Error:", err);
            }

            // 2. ×”×¤×¢×œ×ª ×”-UI
            btn.disabled = true;
            btn.classList.add('opacity-80', 'cursor-wait');
            wandIcon.classList.add('hidden');
            spinner.classList.remove('hidden');
            btnText.innerText = "PROCESSING...";
            status.innerText = "ROUTING THROUGH AI NEURAL NETWORK...";
            status.className = "text-[11px] text-orange-400 uppercase tracking-widest font-bold animate-pulse";

            const isExpertMode = document.getElementById('expert-toggle').checked;
            const payload = {
                style: document.getElementById('style').value,
                key: document.getElementById('key').value,
                mode: document.getElementById('mode').value,
                bpm: parseInt(document.getElementById('bpm').value),
                bars: parseInt(document.getElementById('bars').value),
                swing: parseInt(document.getElementById('swing').value),
                sync_chance: parseInt(document.getElementById('sync').value),
                comp_level: parseInt(document.getElementById('comp').value),
                density: isExpertMode ? parseInt(document.getElementById('density').value) : 50,
                octave_range: isExpertMode ? document.getElementById('octave').value : "auto",
                articulation: isExpertMode ? document.getElementById('artic').value : "auto"
            };

            // 3. ×§×¨×™××” ×œ×©×¨×ª (Render)
            try {
                const response = await fetch('https://ignite-api-mgwq.onrender.com/generate-midi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error("Server Offline");

                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                
                // ×”×ª×™×§×•×Ÿ ×”×©× ×™: ×™×¦×™×¨×ª ×©× ×§×•×‘×¥ ×¢×©×™×¨ ×•×ž×¤×•×¨×˜
                const safeStyle = payload.style.replace(/[^a-zA-Z0-9]/g, '');
                const safeKey = payload.key.replace('#', 'Sharp');
                const timestamp = new Date().toISOString().slice(11,19).replace(/:/g, "");
                a.download = `Ignite_${safeStyle}_${safeKey}_${payload.bpm}BPM_Comp${payload.comp_level}_${timestamp}.mid`;
                
                document.body.appendChild(a);
                a.click();
                a.remove();

                // ×”×ª×™×§×•×Ÿ ×”×¨××©×•×Ÿ: ×”×•×¤×¢×ª ×”×•×“×¢×” ×™×¨×•×§×” ×ž×™×“ ×‘×¢×ª ×”×”×•×¨×“×”
                status.innerText = `ðŸ”¥ IGNITION COMPLETE!`;
                status.className = "text-[11px] text-green-500 uppercase tracking-widest font-black";
                
                // 4. ×¢×“×›×•×Ÿ Firebase ×—×›×
                try {
                    await db.collection('users').doc(user.uid).set({
                        credits_used: creditsUsed + 1,
                        last_active_month: currentMonth,
                        generations_count: firebase.firestore.FieldValue.increment(1)
                    }, { merge: true });
                    
                    updateCreditsUI(user.uid);
                } catch (dbErr) {
                    console.error("DB Update Failed:", dbErr);
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                status.innerText = "CONNECTION FAILED. TRY AGAIN.";
                status.className = "text-[11px] text-red-500 uppercase tracking-widest font-black";
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-80', 'cursor-wait');
                spinner.classList.add('hidden');
                wandIcon.classList.remove('hidden');
                btnText.innerText = "INSPIRE ME";
                
                // ×”×”×•×“×¢×” ×”×™×¨×•×§×” ×ª×™×©××¨ 4 ×©× ×™×•×ª ×•××– ×ª×—×–×•×¨ ×œ-Engine Ready
                setTimeout(() => {
                    if(status.innerText.includes("COMPLETE")) {
                        status.innerText = "ENGINE READY";
                        status.className = "text-[11px] text-gray-500 uppercase tracking-widest font-bold transition-colors duration-1000";
                    }
                }, 4000);
            }
        }
    </script>
</body>
</html>
